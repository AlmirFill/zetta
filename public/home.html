<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <meta name="theme-color" content="#007bff">
    <meta name="description" content="Dashboard de gest√£o de fazendas e rebanho bovino">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Zetta Bovino">
    <title>Meu Dashboard de Fazendas</title>
    <link rel="manifest" href="/manifest.json">
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 192 192'><rect fill='%23007bff' width='192' height='192'/><text x='50%' y='50%' font-size='80' font-weight='bold' fill='white' text-anchor='middle' dominant-baseline='middle' font-family='Arial'>üêÑ</text></svg>">
    <link rel="apple-touch-icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 180 180'><rect fill='%23007bff' width='180' height='180'/><text x='50%' y='50%' font-size='75' font-weight='bold' fill='white' text-anchor='middle' dominant-baseline='middle' font-family='Arial'>üêÑ</text></svg>">
    <script>
        // Define API_BASE_URL imediatamente (antes de qualquer outro script)
        window.API_BASE_URL = window.location.origin;
    </script>
    <style>
        body {
            font-family: Arial, sans-serif;
            background-color: #f0f2f5;
            margin: 0;
            padding: 20px;
        }

        .header {
            background-color: #007bff;
            color: #fff;
            padding: 20px;
            text-align: center;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .container {
            max-width: 900px;
            margin: auto;
            background-color: #fff;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
        }

        h1 {
            margin: 0;
        }

        #fazendas-list {
            list-style: none;
            padding: 0;
            margin-top: 20px;
        }

        .fazenda-item {
            background-color: #e9ecef;
            border: 1px solid #dee2e6;
            padding: 15px;
            margin-bottom: 10px;
            border-radius: 6px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .fazenda-info {
            flex-grow: 1;
        }

        .fazenda-info h3 {
            margin: 0 0 5px 0;
            color: #333;
        }

        .fazenda-info p {
            margin: 0;
            color: #666;
            font-size: 0.9em;
        }

        .message {
            margin-top: 20px;
            padding: 15px;
            border-radius: 4px;
            text-align: center;
            font-weight: bold;
        }

        .message.success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .message.error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        #install-btn {
            display: none;
            position: fixed;
            bottom: 20px;
            right: 20px;
            padding: 12px 20px;
            background-color: #28a745;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
            z-index: 1000;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
        }

        #install-btn:hover {
            background-color: #218838;
        }
    </style>
</head>
<body>

    <div class="header">
        <h1>Meu Dashboard</h1>
        <p>Suas fazendas cadastradas</p>
    </div>

    <div class="container" style="margin-bottom:20px;">
        <div style="display:flex;gap:12px;align-items:flex-start;flex-wrap:wrap;">
            <div style="flex:1;min-width:220px;padding:12px;border-radius:8px;background:#e9f5ff;">
                <h3>Passo 1</h3>
                <p>Cadastrar uma fazenda</p>
                <a href="/cadastro-fazenda.html" style="display:inline-block;margin-top:8px;padding:8px 12px;background:#007bff;color:#fff;border-radius:6px;text-decoration:none;">Cadastrar Fazenda</a>
            </div>
            <div style="flex:1;min-width:220px;padding:12px;border-radius:8px;background:#e9f5ff;">
                <h3>Passo 2</h3>
                <p>Cadastrar bovinos na fazenda</p>
                <a href="/web.bovino-2.html" style="display:inline-block;margin-top:8px;padding:8px 12px;background:#28a745;color:#fff;border-radius:6px;text-decoration:none;">Cadastrar Bovino</a>
            </div>
            <div style="flex:1;min-width:220px;padding:12px;border-radius:8px;background:#e9f5ff;">
                <h3>Passo 3</h3>
                <p>Ver bovinos cadastrados</p>
                <a href="/bovinos.html" style="display:inline-block;margin-top:8px;padding:8px 12px;background:#6c757d;color:#fff;border-radius:6px;text-decoration:none;">Listar Bovinos</a>
            </div>
        </div>
    </div>

    <div class="container">
        <div id="loading-message" class="message">Carregando suas fazendas...</div>
        <div id="no-fazendas" class="message success" style="display:none;">Voc√™ ainda n√£o tem fazendas cadastradas.</div>
        <div id="error-message" class="message error" style="display:none;">Ocorreu um erro ao carregar as fazendas.</div>
        
        <ul id="fazendas-list">
            </ul>
    </div>

    <button id="install-btn">üì• Instalar App</button>

    <script>
        // Registra o Service Worker para funcionalidade offline
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('/service-worker.js')
                .then(registration => {
                    console.log('Service Worker registrado com sucesso:', registration);
                })
                .catch(error => {
                    console.log('Erro ao registrar Service Worker:', error);
                });
        }
        document.addEventListener('DOMContentLoaded', () => {
            const fazendasList = document.getElementById('fazendas-list');
            const loadingMessage = document.getElementById('loading-message');
            const noFazendasMessage = document.getElementById('no-fazendas');
            const errorMessage = document.getElementById('error-message');

            // Fun√ß√£o para ler um cookie (a mesma do exemplo anterior)
            function getCookie(name) {
                const nameEQ = name + "=";
                const ca = document.cookie.split(';');
                for(let i = 0; i < ca.length; i++) {
                    let c = ca[i];
                    while (c.charAt(0) == ' ') c = c.substring(1, c.length);
                    if (c.indexOf(nameEQ) == 0) return c.substring(nameEQ.length, c.length);
                }
                return null;
            }

            async function fetchFazendas() {
                const usuario_id = getCookie('id_usuario'); // ‚ö†Ô∏è Altere 'usuario_id' se o nome do seu cookie for diferente
                
                if (!usuario_id) {
                    loadingMessage.style.display = 'none';
                    errorMessage.textContent = 'Usu√°rio n√£o autenticado. Fa√ßa login para ver suas fazendas.';
                    errorMessage.style.display = 'block';
                    return;
                }

                try {
                    const response = await fetch(`${API_BASE_URL}/fazendas/${usuario_id}`);
                    const result = await response.json();

                    loadingMessage.style.display = 'none';

                    if (response.ok && result.success) {
                        if (result.fazendas.length > 0) {
                            result.fazendas.forEach(fazenda => {
                                const listItem = document.createElement('li');
                                listItem.classList.add('fazenda-item');
                                listItem.innerHTML = `
                                    <div class="fazenda-info">
                                        <h3>${fazenda.nome_fazenda}</h3>
                                        <p>${fazenda.localizacao || 'Localiza√ß√£o n√£o informada'}</p>
                                    </div>
                                    <div style="margin-left:12px;display:flex;gap:8px;align-items:center;">
                                        <button onclick="window.location.href='/bovinos.html?id_fazenda=${fazenda.id_fazenda}'" style="padding:8px 10px;border-radius:6px;background:#007bff;color:#fff;border:none;">Ver Bovinos</button>
                                        <a href="/web.bovino-2.html?id_fazenda=${fazenda.id_fazenda}" style="padding:8px 10px;border-radius:6px;background:#28a745;color:#fff;text-decoration:none;">Cadastrar Bovino</a>
                                    </div>
                                `;
                                fazendasList.appendChild(listItem);
                            });
                        } else {
                            noFazendasMessage.style.display = 'block';
                        }
                    } else {
                        errorMessage.textContent = result.message || 'Ocorreu um erro ao carregar as fazendas.';
                        errorMessage.style.display = 'block';
                    }

                } catch (error) {
                    console.error('Erro na requisi√ß√£o:', error);
                    loadingMessage.style.display = 'none';
                    errorMessage.textContent = 'Erro ao conectar com o servidor.';
                    errorMessage.style.display = 'block';
                }
            }

            fetchFazendas();
        });
    </script>
</body>
</html>